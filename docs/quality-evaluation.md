# Критерии оценки качества проекта и ответов LLM/RAG

Этот документ задаёт единые критерии для проверки качества всего проекта (единой базы знаний и сервисов document-processor, embedding_service, knowledge_base_api, knowledge_base_bot, knowledge-search-api, universal_embedder) и для оценки ответов, которые выдаёт цепочка LLM/RAG. Все пункты применяются при приёмке задач и ретроспективной оценке стабильности.

## 1. Проектный контроль качества

| Область | Что проверять | Сигналы проблемы |
| --- | --- | --- |
| Согласованность настроек | Все сервисы читают одинаковые `embedding_config` (модель, генератор, версия), статусы (`embedding_generation`, `new`, `done`, `failed`) и порты из `settings`. | Разные значения модели/генератора между ingestion и поиском; «неизвестный статус» в логах; коллизии портов. |
| Корректность пайплайна | Документы проходят цепочку: загрузка → парсинг → чанки → очередь на обогащение → эмбеддинги → индексация; события `new`/`deleted` доходят до воркеров. | Чанки без эмбеддингов нужной версии; событие удаления не вызывает деиндексацию; бесконечные ретраи без прогресса. |
| Надёжность кода | Пул соединений с БД, без блокирующих клиентов в async ручках; таймауты/ретраи на внешние вызовы (Ollama, embedding API). | Общий соединение psycopg2 в FastAPI, подвисания event loop, отсутствие фоллбеков. |
| Наблюдаемость | Логируются запросы к LLM/эмбеддингам, метрики запросов/ошибок, трассировки критичных путей; aliveness/health для каждого сервиса. | Пустые логи по llm_requests, нет health эндпоинта или он падает. |
| Безопасность | Отсутствие секретов в коде; входные данные валидируются; ограничения на размер файла/запроса; CORS/аутентификация в API. | Секреты в git; невалидируемые payload, позволяющие SQL/XXE; открытые сервисы без auth. |
| Документация и DX | README/скрипты описывают запуск и переменные; тесты/линтеры воспроизводимы; таблица портов актуальна. | Несогласованные инструкции запуска; устаревшие порты; зависимость от ручных шагов без описания. |
| Тестовое покрытие | Наличие unit-тестов для парсеров, воркеров, логирования LLM; smoke-тесты API (health, базовый поиск). | Тесты отсутствуют или не покрывают критические пути (ингест, поиск, логирование). |

### Минимальный чек-лист при приёмке изменений
- [ ] В settings отображены модель и генератор эмбеддингов, версия и размеры соответствуют используемому backend.
- [ ] Очереди: события `new`/`deleted` попадают в воркеры; статусы переходят в `done`/`failed` без зависаний.
- [ ] Чанки без эмбеддингов или со старой версией догоняются backfill-воркером.
- [ ] API: health endpoints и поиск открываются на уникальных портах; основные ручки отвечают 2xx.
- [ ] Наблюдаемость: записи в `llm_requests_log` появляются по каждому запросу к LLM/embeddings.
- [ ] Безопасность: нет секретов в git, включена валидация входных данных, лимиты на размер/время запросов.

## 2. Критерии качества ответов LLM/RAG

| Критерий | Описание | Оценка |
| --- | --- | --- |
| Точность и привязка к данным | Ответ основан на извлечённых чанках; выводы не выходят за пределы фактов; указаны цитаты/ссылки. | **ОК** — все факты подтверждены источниками; **WARN** — недостаточно цитат, но факты совпадают; **FAIL** — галлюцинации/нет ссылок. |
| Полнота | Закрыты все вопросы пользователя; включены ограничения/предпосылки (тенант, версия данных, фильтры). | ОК — ответы на все подпункты; WARN — частичное покрытие; FAIL — ключевые части пропущены. |
| Согласованность с процессом | Учитываются статусные правила (только `embedding_generation=done`), выбор генератора/устройства; сохраняется `conversation_id`. | ОК — соблюдены правила; WARN — неточности без риска ошибки; FAIL — нарушены фильтры/устройства. |
| Ясность и структура | Заголовки, списки, таблицы при необходимости; лаконичные формулировки на языке запроса. | ОК — читаемо и структурировано; WARN — громоздко; FAIL — нечитабельно. |
| Безопасность и тон | Нет утечки секретов, соблюдены ограничения модели; есть дисклеймер при неопределённости или fallback. | ОК — безопасно; WARN — не хватает оговорок; FAIL — раскрытие чувствительной информации. |
| Производительность/стоимость | Не тратит лишние токены (нет дубликатов истории), использует стриминг при необходимости; выбирает доступный backend. | ОК — оптимизировано; WARN — небольшие издержки; FAIL — значительный перерасход или неправильный backend. |

### Практические правила проверки
- Ответ должен содержать ссылки на чанки/источники, если они есть; при сбое генерации — fallback с цитатами.
- История диалога не дублируется: передаётся в одну секцию промпта, но токены учитываются при бюджетировании.
- В запросе зашиты фильтры по статусу эмбеддингов и их версии; запросы к embeddings используют тот же генератор и устройство, что и ingestion.
- Логирование: каждый вызов LLM/embedding фиксируется в `llm_requests_log` с ключами запроса/ответа и статусом (успех/ошибка/fallback).
- Для многошаговых ответов (граф, несколько вопросов) проверять, что все подзадачи выполнены и результат согласован.

## 3. Оценка полноты и завершённости работы пользователя с LLM/RAG

Используйте эти правила, чтобы понять, завершена ли задача и достаточно ли покрыты данные:

1. **Покрытие данных**: доля чанков со статусом `embedding_generation=done` и нужной версией ≥ целевого порога (например, 95%). Если меньше — запускается backfill.
2. **Консистентность индексации**: для каждого документа `is_deleted` или статус `deleted` приводит к деиндексации; нет активных задач с устаревшей версией модели.
3. **Сходимость поиска**: контрольные запросы к knowledge-search-api возвращают релевантные документы из свежих чанков; отклонения фиксируются в багрепортах.
4. **Отчёт по логам**: в `llm_requests_log` есть записи для всех тестовых вызовов (включая ошибки и fallback), время ответа и используемый backend задокументированы.
5. **UX и поток**: bot/UI передают правильный `conversation_id`, не теряют контекст, отображают предупреждения при отсутствии очистки истории или при fallback-ответах.
6. **Документация**: README/операционные инструкции обновлены под выбранный backend, порты и флаги; перечислены ограничения/известные проблемы.

### Итоговый вердикт
- **Готово**: выполнены пункты чек-листа, критерии ответов в состоянии **ОК**, порог покрытия данных достигнут, логирование полное.
- **Требует доработки**: есть пункты **WARN**, но без критичных провалов; зафиксирован план исправлений.
- **Не принято**: любой **FAIL** по точности/безопасности ответов или существенное нарушение конвейера ingestion/поиска.
