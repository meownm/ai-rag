# Оценка текущего состояния сервисов

Оценка выполнена по критериям из `docs/quality-evaluation.md`: согласованность настроек, корректность пайплайна, надёжность, наблюдаемость, безопасность, документация/тесты. Статусы: **OK** — соответствует; **WARN** — требуется внимание; **FAIL** — критическая проблема.

## document-processor
| Критерий | Оценка | Обоснование |
| --- | --- | --- |
| Согласованность настроек | OK | При старте проверяет `embedding_config` и сравнивает модель/размерность/генератор с .env, инициируя миграцию при расхождении.【F:document-processor/main.py†L92-L140】 |
| Корректность пайплайна | OK | Перед парсингом очищает старые версии документов и обрабатывает файл, формируя чанки без дубликатов; поддерживает переиндексацию через download/parse_any.【F:document-processor/worker.py†L172-L200】 |
| Надёжность | OK | Для вызовов embedding API есть экспоненциальные ретраи и переключение на CPU при OOM, чтобы избежать зависаний.【F:document-processor/worker.py†L83-L134】【F:document-processor/worker.py†L136-L170】 |
| Наблюдаемость | OK | Метрики Prometheus и ротируемые логи настроены по умолчанию, воркеры перезапускаются супервизором при сбое.【F:document-processor/worker.py†L42-L90】【F:document-processor/main.py†L40-L90】 |
| Безопасность | WARN | Сервис слушает без аутентификации и предназначен для внутреннего использования; при внешней экспозиции потребуется защита сети и auth. |
| Документация/тесты | OK | Покрыт unit-тестами вспомогательных функций (нормализация, таблицы, embedding API) для критичных путей воркера.【F:document-processor/tests/test_worker_helpers.py†L1-L120】 |

## embedding_backfill_worker
| Критерий | Оценка | Обоснование |
| --- | --- | --- |
| Согласованность настроек | OK | Читает `embedding_config` из БД, включая `generator`, и использует единый DSN; ошибка, если конфиг отсутствует, предотвращает расхождение моделей.【F:embedding_backfill_worker/worker.py†L26-L106】 |
| Корректность пайплайна | OK | Берёт чанки с отсутствующими или устаревшими эмбеддингами через `FOR UPDATE SKIP LOCKED` и помечает статус `embedding_generation` перед обработкой, исключая гонки.|【F:embedding_backfill_worker/worker.py†L122-L153】 |
| Надёжность | WARN | Обработка API ошибок прописана, но нет ретраев/таймаутов выше 60 c для Ollama/OpenAI вызовов, что может блокировать батч в случае сети.【F:embedding_backfill_worker/worker.py†L154-L180】 |
| Наблюдаемость | WARN | Логирование есть, но отсутствуют метрики или записи в `llm_requests_log`, поэтому сложнее отслеживать прогресс.【F:embedding_backfill_worker/worker.py†L18-L23】 |
| Безопасность | WARN | Работает напрямую с БД и внешними API без аутентификации на уровне сервиса; предполагается внутренний запуск. | |
| Документация/тесты | WARN | Нет unit-тестов самого воркера; поведение зависит от интеграционных окружений.| |

## knowledge-search-api
| Критерий | Оценка | Обоснование |
| --- | --- | --- |
| Согласованность настроек | OK | Загружает `embedding_config` из таблицы settings (модель/генератор/режим) и размещает модель на выбранном устройстве при старте.|【F:knowledge-search-api/main.py†L38-L114】 |
| Корректность пайплайна | OK | Фильтрует поисковые запросы по статусу, строит fallback с цитатами при пустом результате и поддерживает графовый контекст.|【F:knowledge-search-api/main.py†L164-L210】 |
| Надёжность | OK | При недоступности LLM формирует безопасный ответ с цитатами; health-checkы для Postgres/Neo4j/Ollama интегрированы.|【F:knowledge-search-api/main.py†L151-L206】【F:knowledge-search-api/main.py†L32-L33】 |
| Наблюдаемость | OK | Все вызовы LLM/embeddings логируются в `llm_requests_log` через общий helper с таймстемпами и статусом.|【F:knowledge-search-api/llm_logging.py†L7-L72】 |
| Безопасность | WARN | CORS открыт на все источники и отсутствует аутентификация, поэтому при публичном доступе требуется отдельный шлюз/ограничения.|【F:knowledge-search-api/main.py†L131-L138】 |
| Документация/тесты | OK | Наличие unit-тестов ретривера и логирования покрывает фильтры, endpoint Ollama и запись в лог.|【F:knowledge-search-api/tests/test_retrieval_helpers.py†L1-L123】【F:knowledge-search-api/tests/test_llm_logging.py†L1-L120】 |

## knowledge_base_api
| Критерий | Оценка | Обоснование |
| --- | --- | --- |
| Согласованность настроек | OK | При старте создаёт таблицы и сидирует дефолтные tenant/admin записи, используя значения из настроек.|【F:knowledge_base_api/main.py†L70-L126】 |
| Корректность пайплайна | OK | События по файлам создают/закрывают версии и обеспечивают атомарную фиксацию операций загрузки/удаления.|【F:knowledge_base_api/services.py†L88-L140】 |
| Надёжность | OK | Ошибки загрузки в S3 транслируются в контролируемый HTTP-ответ; базовые health/status ручки присутствуют.|【F:knowledge_base_api/main.py†L48-L170】 |
| Наблюдаемость | WARN | Нет логирования запросов к LLM/эмбеддингам на этом уровне; метрики не публикуются, только HTTP-логирование.| |
| Безопасность | OK | Auth-роутер подключён, middleware добавляет trace-id; health-check проверяет БД и S3.|【F:knowledge_base_api/main.py†L17-L140】【F:knowledge_base_api/main.py†L146-L170】 |
| Документация/тесты | WARN | Юнит-тесты отсутствуют в репозитории для REST-ручек; требуется покрытие загрузки/удаления.| |

## knowledge_base_bot
| Критерий | Оценка | Обоснование |
| --- | --- | --- |
| Согласованность настроек | OK | Работает с теми же статусами (`new/processing/done/failed`) и дергает прямые UUID эндпоинты KB API.|【F:knowledge_base_bot/bot.py†L21-L153】 |
| Корректность пайплайна | OK | Обработчики команд используют авторизованный клиент с автоматическим обновлением токена и закрытием HTTP-клиентов.|【F:knowledge_base_bot/bot.py†L57-L152】 |
| Надёжность | WARN | Обработка ошибок в коллбэках минимальна; сетевые сбои могут приводить к неподтверждённым действиям пользователя.| |
| Наблюдаемость | WARN | Ведётся только базовый логгер Telegram; нет метрик или трассировки запросов к KB API.| |
| Безопасность | OK | Токен Telegram и креды KB API загружаются из окружения; обращения идут по Bearer токену.|【F:knowledge_base_bot/bot.py†L21-L153】 |
| Документация/тесты | WARN | Нет тестов для бота; требуется хотя бы покрытие клиентов и обработчиков команд.| |

## rag-search-ui / landing
| Критерий | Оценка | Обоснование |
| --- | --- | --- |
| Согласованность настроек | OK | UI берёт базовый URL из `VITE_KB_SEARCH_API`, что синхронизирует среду и порты с основным API.|【F:rag-search-ui/services/api.ts†L1-L27】 |
| Корректность пайплайна | OK | SSE-клиент сохраняет разговоры и корректно обрабатывает потоковые ответы/ошибки без лишних вызовов.|【F:rag-search-ui/services/api.ts†L5-L61】 |
| Надёжность | WARN | Нет автоповторов запросов и отображения состояния health; ошибки просто пробрасываются пользователю.| |
| Наблюдаемость | WARN | Отсутствуют метрики/трассировка фронтенда; логирование ограничено консолью браузера.| |
| Безопасность | WARN | UI доверяет открытым CORS и не проверяет аутентификацию; требуется защита на уровне API/прокси.|【F:knowledge-search-api/main.py†L131-L138】 |
| Документация/тесты | WARN | Нет автоматизированных тестов UI; требуется e2e или компонентные проверки.| |

## Общий вывод
- **Пайплайн и настройки** согласованы между ingestion и поиском: embedding_config читается всеми ключевыми сервисами, статусы и версия учитываются (OK).
- **Наблюдаемость/безопасность**: слабые места — открытый CORS без auth в search API, отсутствуют метрики у backfill воркера, бота и UI; рекомендуется добавить защиту и метрики (WARN).
- **Тесты**: критичные части поиска и парсинга покрыты, но KB API, бот, UI и backfill воркер остаются без тестов (WARN).
