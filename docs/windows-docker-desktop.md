# Windows: запуск всех сервисов в Docker Desktop

Скрипт [`setup-docker-desktop.bat`](../setup-docker-desktop.bat) собирает и поднимает все компоненты проекта под Docker Desktop на Windows.

## Требования
- Предустановленный Docker Desktop с включённым Docker CLI.
- Свежий Git-клон репозитория (скрипт запускается из корня).
- Готовые файлы окружения для сервисов, которые требуют секреты:
  - `document-processor/.env` (скрипт создаст копию из `.env.example`, если её нет).
  - `knowledge_base_api/.env.docker` (нужно заполнить вручную).
  - `rag_observability_stack/.env` (нужно заполнить вручную значениями для Postgres, портов и ключей).
  - `universal_embedder/.env` (копируется из `.env.example`, отредактируйте DSN и модель).
  - `knowledge_base_bot/.env` (Telegram токен и данные доступа к API знаний).
  - `knowledge-search-api` использует переменные окружения `DB_*`, `OLLAMA_*`, `NEO4J_*` и модельные настройки; при их отсутствии будут применены дефолтные значения, но подключение к БД может не пройти.

## Как работает скрипт

### Пошаговая логика
1. Проверяет наличие Docker CLI (`where docker`) и подключение к движку (`docker info`). При ошибке выводит явное сообщение и останавливается.
2. Для каждого сервиса определяет, нужно ли ему `.env`. Если переменная окружения отсутствует, но лежит шаблон (`.env.example` или `.env.docker.example`), копирует его и предупреждает, что значения стоит отредактировать; если нет даже шаблона — сервис помечается как «пропущен» и дальше не запускается.
3. Сервисы с `docker-compose.yml` поднимает через `docker compose up -d --build`, чтобы убедиться в актуальном билде и фоновой работе:
   - `document-processor` (`8010:8010`),
   - `embedding_service` (`8101/8102:8000` для CPU/GPU),
   - `knowledge_base_api` (`8001:8001`),
   - `rag_observability_stack` (порты читаются из `.env`).
4. Для остальных сервисов, где требуется индивидуальная сборка, выполняет `docker build` и затем `docker run` с именем контейнера, пробросом портов и `--env-file`, если файл найден:
   - `knowledge-search-api` (`8000:8000`),
   - `universal_embedder` (`8012:8012`, healthcheck внутри образа),
   - `knowledge_base_bot` (без проброса портов, использует HTTP-клиент для доступа к API).
5. После обработки всех сервисов выводит итог: если хотя бы один билд/старт завершился ошибкой — скрипт вернёт код 1 и сообщит, какой сервис упал; если были только пропуски — завершится успешно, оставив запущенными все, что прошло проверки.

### Поведение при повторных запусках
- `docker compose up -d --build` безопасно пересоберёт и перезапустит связанные сервисы; незаконченные контейнеры будут заменены свежими.
- Для контейнеров, которые запускаются вручную, скрипт перед `docker run` выполняет `docker rm -f <name>`, чтобы очистить предыдущий экземпляр и освободить порты.
- Если вы исправили `.env` или добавили его впервые, достаточно повторно запустить скрипт — он поднимет ранее пропущенные сервисы.

## Запуск
Из корня репозитория выполните в PowerShell или Command Prompt:

```bat
setup-docker-desktop.bat
```

После успешного выполнения все контейнеры, которые не были пропущены, будут запущены в Docker Desktop.
