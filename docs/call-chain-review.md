# Ревью цепочки вызовов (Telegram-бот → База знаний → Document Processor → Эмбеддер)

Ниже перечислены проблемные места, найденные при анализе фактического кода, влияющие на корректность алгоритмов и согласованность API.

## 1. Бот дергает поиск по имени, хотя в коллбэках передает UUID
В `button_callback_handler` бот получает `item_uuid` из callback-data, но затем ищет элемент через `/items/search`, который ищет по частичному совпадению имени. Для файлов с UUID в качестве запроса `search` почти всегда вернет пустой список, из‑за чего кнопки «Скачать», «Удалить», «Изменить статус» будут часто отвечать "Элемент был удален или изменен" даже для существующих элементов. Нужно добавить API получения элемента по UUID или прокидывать в callback полное описание элемента без повторного поиска.

## 2. События удаления не попадают в очередь Document Processor
Очередь Document Processor забирает только `knowledge_events` со статусом `new` и нужной операцией. Маркер удаления (`/items/{uuid}`) записывает новое событие с операцией `deleted`, но копирует статус предыдущего события (обычно `done` или `processing`) и поэтому не помечает его как `new`. В результате `deletion_worker` никогда не увидит задачу и не почистит документы/чанки/Neo4j. Нужно при создании события удаления всегда проставлять `status = 'new'`.

## 3. Несогласованный формат статуса обогащения между Document Processor и universal_embedder
Document Processor помечает прогресс генерации эмбеддингов в `enrichment_status.embedding_generation` и закрывает его в `completed`, а universal_embedder теперь должен использовать то же поле вместо `enrichment_status.embedding_task`. При несогласовании чанки остаются с незакрытым `embedding_generation = pending`, что повторно подхватывается Document Processor и приводит к дублированию. Ключ статуса следует унифицировать на `embedding_generation` во всех сервисах.
