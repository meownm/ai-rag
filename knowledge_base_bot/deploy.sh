#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –ò–º—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω–æ –≤–∞—à–µ–º—É Docker-–æ–±—Ä–∞–∑—É
IMAGE_NAME="knowledge-base-bot"
# –ò–º—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω–æ –∑–∞–ø—É—â–µ–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
CONTAINER_NAME="kb_telegram_bot"

# --- –õ–û–ì–ò–ö–ê –°–ö–†–ò–ü–¢–ê ---

# –ü—Ä–µ–∫—Ä–∞—â–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -e

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
echo "üîµ –®–∞–≥ 1/4: –ü–æ–∏—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
    docker stop $CONTAINER_NAME
    echo "  - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$CONTAINER_NAME' –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
fi

if [ "$(docker ps -aq -f name=$CONTAINER_NAME)" ]; then
    docker rm $CONTAINER_NAME
    echo "  - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$CONTAINER_NAME' —É–¥–∞–ª–µ–Ω."
fi

# 2. –°–±–æ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞
echo "üîµ –®–∞–≥ 2/4: –°–±–æ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ Docker-–æ–±—Ä–∞–∑–∞ '$IMAGE_NAME'..."
docker build -t $IMAGE_NAME .
echo "  - –û–±—Ä–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω."

# 3. –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
echo "üîµ –®–∞–≥ 3/4: –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ '$CONTAINER_NAME'..."
docker run -d \
    --name $CONTAINER_NAME \
    --restart unless-stopped \
    --env-file .env \
    $IMAGE_NAME
echo "  - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ."

# 4. –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
echo "üîµ –®–∞–≥ 4/4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
docker ps -f name=$CONTAINER_NAME

echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "   –ß—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É: docker logs -f $CONTAINER_NAME"