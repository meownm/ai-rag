# ===================================================================
# –°–ö–†–ò–ü–¢ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –î–ï–ü–õ–û–Ø –î–õ–Ø WINDOWS (POWERSHELL)
# ===================================================================

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –ò–º—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω–æ –≤–∞—à–µ–º—É Docker-–æ–±—Ä–∞–∑—É
$ImageName = "knowledge-base-bot"
# –ò–º—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω–æ –∑–∞–ø—É—â–µ–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
$ContainerName = "kb_telegram_bot"

# --- –õ–û–ì–ò–ö–ê –°–ö–†–ò–ü–¢–ê ---

# –ü—Ä–µ–∫—Ä–∞—â–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ. –ê–Ω–∞–ª–æ–≥ 'set -e' –≤ bash.
$ErrorActionPreference = "Stop"

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
Write-Host -ForegroundColor Yellow "üîµ –®–∞–≥ 1/4: –ü–æ–∏—Å–∫ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."

# –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ —Ç–æ—á–Ω–æ–º—É –∏–º–µ–Ω–∏ (running –∏–ª–∏ stopped)
$existingContainer = docker ps -a -q -f "name=^$($ContainerName)$"
if ($existingContainer) {
    Write-Host "  - –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    docker stop $ContainerName
    Write-Host "  - –£–¥–∞–ª—è—é..."
    docker rm $ContainerName
    Write-Host "  - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$ContainerName' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω."
} else {
    Write-Host "  - –°—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞—é."
}

# 2. –°–±–æ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ Docker-–æ–±—Ä–∞–∑–∞
Write-Host -ForegroundColor Yellow "üîµ –®–∞–≥ 2/4: –°–±–æ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ Docker-–æ–±—Ä–∞–∑–∞ '$ImageName'..."
docker build -t $ImageName .
Write-Host -ForegroundColor Green "  - –û–±—Ä–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω."

# 3. –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
Write-Host -ForegroundColor Yellow "üîµ –®–∞–≥ 3/4: –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ '$ContainerName'..."
docker run -d `
    --name $ContainerName `
    --restart unless-stopped `
    --env-file .env `
    $ImageName
Write-Host -ForegroundColor Green "  - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ."

# 4. –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç–∞—Ç—É—Å–µ
Write-Host -ForegroundColor Yellow "üîµ –®–∞–≥ 4/4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
docker ps -f "name=$($ContainerName)"

Write-Host -ForegroundColor Green "`n‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
Write-Host "   –ß—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É: docker logs -f $ContainerName"