# ===================================================================
# Этап 1: Базовый образ с Python и Poetry
# ===================================================================
FROM python:3.11-slim as base

# Настройки для корректной работы Python в Docker
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# Установка рабочей директории
WORKDIR /app

# Установка Poetry
RUN pip install --no-cache-dir poetry

# ===================================================================
# Этап 2: "Строитель" для установки зависимостей
# Этот слой будет кэшироваться, если зависимости не меняются
# ===================================================================
FROM base as builder

# Копируем только файлы зависимостей
COPY pyproject.toml poetry.lock ./

# Устанавливаем зависимости, исключая пакеты для разработки
RUN poetry install --no-interaction --no-ansi --no-dev

# ===================================================================
# Этап 3: Финальный, легковесный образ
# ===================================================================
FROM base

# Копируем только установленные пакеты из "строителя"
COPY --from=builder /app/.venv /app/.venv

# Добавляем виртуальное окружение в PATH, чтобы команды работали напрямую
ENV PATH="/app/.venv/bin:$PATH"

# Копируем исходный код приложения
COPY bot.py .

# Команда для запуска бота при старте контейнера
CMD ["python", "bot.py"]